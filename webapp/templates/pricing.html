<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing - FolioForecast</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&family=DM+Serif+Display&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Clerk for authentication -->
    <script
        async
        crossorigin="anonymous"
        data-clerk-publishable-key="{{ clerk_config.publishable_key }}"
        src="https://{{ clerk_config.frontend_api }}/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
        type="text/javascript"
    ></script>
    
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --text-primary: #ffffff;
            --text-secondary: #d1d5db;
            --text-muted: #6b7280;
            --accent-blue: #3b82f6;
            --accent-blue-hover: #2563eb;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --border-color: #2a2a3a;
            --warning: #f59e0b;
            
            /* Fonts */
            --font-display: "DM Serif Display", Georgia, serif;
            --font-body: "DM Sans", -apple-system, BlinkMacSystemFont, sans-serif;
            --font-inter: 'Inter', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Navigation */
        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(10, 10, 15, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Logo Styles */
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1rem;
            color: white;
            font-family: var(--font-body);
        }

        .logo-text {
            font-family: var(--font-display);
            font-size: 1.35rem;
            letter-spacing: -0.02em;
            color: var(--text-primary);
        }

        /* Branding Specifics */
        .sigma {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            color: var(--accent-blue);
        }
        
        .return-r {
            color: var(--accent-green);
            font-size: 0.8em; 
            font-weight: 700;
            vertical-align: middle;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
            font-size: 0.95rem;
        }

        .nav-links a:hover {
            color: var(--text-primary);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .nav-links .btn {
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(59, 130, 246, 0.30);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: #2a2a3a;
        }

        /* Hero Section */
        .hero {
            padding: 10rem 2rem 4rem;
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }

        .hero h1 {
            font-family: var(--font-display);
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .hero p {
            font-size: 1.25rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Pricing Section */
        .pricing-section {
            padding: 4rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            margin-bottom: 3rem;
        }

        @media (max-width: 900px) {
            .pricing-grid {
                grid-template-columns: 1fr;
                max-width: 400px;
                margin: 0 auto 3rem;
            }
        }

        .pricing-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            position: relative;
            transition: all 0.3s;
        }

        .pricing-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-blue);
        }

        .pricing-card.featured {
            border-color: var(--accent-green);
            background: linear-gradient(180deg, rgba(16, 185, 129, 0.1) 0%, var(--bg-secondary) 100%);
        }

        .pricing-card.featured::before {
            content: 'MOST POPULAR';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            padding: 0.25rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .pricing-tier {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .pricing-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .pricing-amount {
            display: flex;
            align-items: baseline;
            margin-bottom: 1.5rem;
        }

        .pricing-currency {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .pricing-value {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .pricing-period {
            font-size: 1rem;
            color: var(--text-muted);
            margin-left: 0.25rem;
        }

        .pricing-features {
            list-style: none;
            margin-bottom: 2rem;
        }

        .pricing-features li {
            padding: 0.5rem 0;
            color: var(--text-secondary);
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            font-size: 0.95rem;
        }

        .pricing-features li::before {
            content: '✓';
            color: var(--accent-green);
            font-weight: 700;
            flex-shrink: 0;
        }

        .pricing-features li.disabled {
            color: var(--text-muted);
            text-decoration: line-through;
        }

        .pricing-features li.disabled::before {
            content: '✗';
            color: var(--text-muted);
        }

        /* Pricing CTA Button Styles */
        .pricing-cta {
            display: block;
            width: 100%;
            padding: 0.875rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.95rem;
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-family: inherit;
        }

        .pricing-cta.secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .pricing-cta.secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .pricing-cta.primary {
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            border: none;
        }

        .pricing-cta.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        /* Loading state for buttons */
        .pricing-cta.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .pricing-cta.loading::after {
            content: '...';
            animation: dots 1s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* No Refunds Notice */
        .refund-notice {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1));
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 1.5rem 2rem;
            max-width: 800px;
            margin: 0 auto 3rem;
            text-align: center;
        }

        .refund-notice h3 {
            color: var(--warning);
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .refund-notice p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .refund-notice a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        .refund-notice a:hover {
            text-decoration: underline;
        }

        /* FAQ Section */
        .faq-section {
            padding: 4rem 2rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .faq-section h2 {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 2rem;
            font-family: var(--font-display);
        }

        .faq-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .faq-question {
            padding: 1.25rem 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .faq-question:hover {
            background: var(--bg-tertiary);
        }

        .faq-question::after {
            content: '+';
            font-size: 1.5rem;
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .faq-item.open .faq-question::after {
            transform: rotate(45deg);
        }

        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .faq-item.open .faq-answer {
            max-height: 500px;
        }

        .faq-answer-content {
            padding: 0 1.5rem 1.25rem;
            color: var(--text-secondary);
        }

        /* Comparison Table */
        .comparison-section {
            padding: 4rem 2rem;
            max-width: 1000px;
            margin: 0 auto;
        }

        .comparison-section h2 {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 2rem;
            font-family: var(--font-display);
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 1rem 1.5rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .comparison-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-primary);
        }

        .comparison-table th:first-child,
        .comparison-table td:first-child {
            text-align: left;
        }

        .comparison-table td {
            color: var(--text-secondary);
        }

        .comparison-table tr:last-child td {
            border-bottom: none;
        }

        .comparison-table td.check {
            color: var(--accent-green);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .cross {
            color: var(--text-muted);
        }

        /* Footer */
        .footer {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 3rem 2rem;
            margin-top: 4rem;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .footer-brand {
            max-width: 300px;
        }

        .footer-brand .logo {
            margin-bottom: 1rem;
            display: inline-flex;
        }

        .footer-brand p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .footer-links {
            display: flex;
            gap: 4rem;
        }

        .footer-column h4 {
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 800;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .footer-column a {
            display: block;
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.25rem 0;
            font-size: 0.9rem;
            transition: color 0.2s;
        }

        .footer-column a:hover {
            color: var(--text-primary);
        }

        .footer-bottom {
            max-width: 1200px;
            margin: 2rem auto 0;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="/" class="logo">
                <div class="logo-icon">FF</div>
                <span class="logo-text">F<span class="sigma">σ</span>lioFo<span class="return-r">R</span>ecast</span>
            </a>
            <div class="nav-links">
                <a href="/#features">Features</a>
                <a href="/pricing">Pricing</a>
                <a href="/app" class="btn btn-primary">Launch App</a>
            </div>
        </div>
    </nav>

    <section class="hero">
        <h1>Simple, Transparent Pricing</h1>
        <p>Start free, upgrade when you need more power. No hidden fees, no surprises.</p>
    </section>

    <section class="pricing-section">
        <div class="pricing-grid">
            <!-- FREE TIER -->
            <div class="pricing-card">
                <div class="pricing-tier">Free</div>
                <div class="pricing-description">Perfect for getting started</div>
                <div class="pricing-amount">
                    <span class="pricing-currency">$</span>
                    <span class="pricing-value">0</span>
                    <span class="pricing-period">/month</span>
                </div>
                <ul class="pricing-features">
                    <li>Up to 10 assets per portfolio</li>
                    <li>1 saved portfolio</li>
                    <li>Basic optimization methods</li>
                    <li>Daily market data</li>
                    <li>Standard analytics</li>
                    <li class="disabled">Advanced optimization</li>
                    <li class="disabled">Robust optimization</li>
                    <li class="disabled">CSV export</li>
                    <li class="disabled">Priority support</li>
                </ul>
                <a href="/app" class="pricing-cta secondary">Get Started Free</a>
            </div>

            <!-- PREMIUM TIER -->
            <div class="pricing-card">
                <div class="pricing-tier">Premium</div>
                <div class="pricing-description">For serious investors</div>
                <div class="pricing-amount">
                    <span class="pricing-currency">$</span>
                    <span class="pricing-value">14</span>
                    <span class="pricing-period">/month</span>
                </div>
                <ul class="pricing-features">
                    <li>Up to 25 assets per portfolio</li>
                    <li>3 saved portfolios</li>
                    <li>All optimization methods</li>
                    <li>Daily market data</li>
                    <li>Advanced analytics</li>
                    <li>Robust optimization</li>
                    <li>CSV export</li>
                    <li class="disabled">Diversification analytics</li>
                    <li class="disabled">Group constraints</li>
                    <li class="disabled">API access</li>
                </ul>
                <button type="button" id="btn-premium" onclick="subscribeToTier('premium')" class="pricing-cta secondary">Start Premium</button>
            </div>

            <!-- PRO TIER -->
            <div class="pricing-card featured">
                <div class="pricing-tier">Pro</div>
                <div class="pricing-description">For professionals & teams</div>
                <div class="pricing-amount">
                    <span class="pricing-currency">$</span>
                    <span class="pricing-value">29</span>
                    <span class="pricing-period">/month</span>
                </div>
                <ul class="pricing-features">
                    <li>Unlimited assets per portfolio</li>
                    <li>Unlimited saved portfolios</li>
                    <li>All optimization methods</li>
                    <li>Real-time market data</li>
                    <li>Full analytics suite</li>
                    <li>Robust optimization</li>
                    <li>CSV & API export</li>
                    <li>Diversification analytics</li>
                    <li>Priority support</li>
                </ul>
                <button type="button" id="btn-pro" onclick="subscribeToTier('pro')" class="pricing-cta primary">Start Free Trial</button>
            </div>
        </div>

        <div class="refund-notice">
            <h3>⚠️ Important: No Refunds Policy</h3>
            <p>All subscription payments are final and non-refundable. We encourage you to fully evaluate our free tier before subscribing. 
               By subscribing, you acknowledge and accept our <a href="/terms">Terms of Service</a> including the no-refunds policy.</p>
        </div>
    </section>

    <section class="comparison-section">
        <h2>Feature Comparison</h2>
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>Feature</th>
                    <th>Free</th>
                    <th>Premium</th>
                    <th>Pro</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Assets per Portfolio</td>
                    <td>10</td>
                    <td>25</td>
                    <td>Unlimited</td>
                </tr>
                <tr>
                    <td>Saved Portfolios</td>
                    <td>1</td>
                    <td>3</td>
                    <td>Unlimited</td>
                </tr>
                <tr>
                    <td>Basic Optimization</td>
                    <td class="check">✓</td>
                    <td class="check">✓</td>
                    <td class="check">✓</td>
                </tr>
                <tr>
                    <td>Advanced Optimization</td>
                    <td class="cross">—</td>
                    <td class="check">✓</td>
                    <td class="check">✓</td>
                </tr>
                <tr>
                    <td>Robust Optimization</td>
                    <td class="cross">—</td>
                    <td class="check">✓</td>
                    <td class="check">✓</td>
                </tr>
                <tr>
                    <td>Diversification Analytics</td>
                    <td class="cross">—</td>
                    <td class="cross">—</td>
                    <td class="check">✓</td>
                </tr>
                <tr>
                    <td>Group Constraints</td>
                    <td class="cross">—</td>
                    <td class="cross">—</td>
                    <td class="check">✓</td>
                </tr>
                <tr>
                    <td>CSV Export</td>
                    <td class="cross">—</td>
                    <td class="check">✓</td>
                    <td class="check">✓</td>
                </tr>
                <tr>
                    <td>API Access</td>
                    <td class="cross">—</td>
                    <td class="cross">—</td>
                    <td class="check">✓</td>
                </tr>
                <tr>
                    <td>Priority Support</td>
                    <td class="cross">—</td>
                    <td class="cross">—</td>
                    <td class="check">✓</td>
                </tr>
            </tbody>
        </table>
    </section>

    <section class="faq-section">
        <h2>Frequently Asked Questions</h2>

        <div class="faq-item">
            <div class="faq-question">Can I cancel my subscription anytime?</div>
            <div class="faq-answer">
                <div class="faq-answer-content">
                    Yes, you can cancel your subscription at any time. Your access will continue until the end of your current billing period. 
                    Please note that cancellation does not entitle you to a refund for any unused portion of your subscription.
                </div>
            </div>
        </div>

        <div class="faq-item">
            <div class="faq-question">What payment methods do you accept?</div>
            <div class="faq-answer">
                <div class="faq-answer-content">
                    We accept all major credit cards (Visa, Mastercard, American Express) and debit cards through our secure payment processor, Stripe.
                </div>
            </div>
        </div>

        <div class="faq-item">
            <div class="faq-question">Is there a refund policy?</div>
            <div class="faq-answer">
                <div class="faq-answer-content">
                    All payments are final and non-refundable. This includes partial month charges, unused subscription time, and accidental purchases. 
                    We strongly encourage you to fully evaluate our free tier before subscribing to ensure FolioForecast meets your needs.
                </div>
            </div>
        </div>

        <div class="faq-item">
            <div class="faq-question">Can I switch between plans?</div>
            <div class="faq-answer">
                <div class="faq-answer-content">
                    Yes! You can upgrade or downgrade your plan at any time. When upgrading, you'll be charged the prorated difference immediately. 
                    When downgrading, the change takes effect at the start of your next billing cycle.
                </div>
            </div>
        </div>

        <div class="faq-item">
            <div class="faq-question">What happens to my portfolios if I downgrade?</div>
            <div class="faq-answer">
                <div class="faq-answer-content">
                    Your portfolios are preserved, but you'll need to reduce them to meet the limits of your new plan before you can run new optimizations. 
                    We'll never delete your data without your consent.
                </div>
            </div>
        </div>

        <div class="faq-item">
            <div class="faq-question">Do you offer annual billing?</div>
            <div class="faq-answer">
                <div class="faq-answer-content">
                    Not currently, but we're considering adding annual plans with a discount in the future. Sign up for our newsletter to stay informed about new offerings.
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-brand">
                <a href="/" class="logo">
                    <div class="logo-icon">FF</div>
                    <span class="logo-text">F<span class="sigma">σ</span>lioFo<span class="return-r">R</span>ecast</span>
                </a>
                <p>Professional-grade portfolio optimization tools for modern investors.</p>
            </div>
            <div class="footer-links">
                <div class="footer-column">
                    <h4>Product</h4>
                    <a href="/#features">Features</a>
                    <a href="/pricing">Pricing</a>
                    <a href="/app">Launch App</a>
                </div>
                <div class="footer-column">
                    <h4>Legal</h4>
                    <a href="/terms">Terms of Service</a>
                    <a href="/privacy">Privacy Policy</a>
                    <a href="/disclaimer">Disclaimer</a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 FolioForecast. All rights reserved. Not financial advice.</p>
        </div>
    </footer>

    <script>
        // =====================================================================
        // FAQ ACCORDION
        // =====================================================================
        document.querySelectorAll('.faq-question').forEach(question => {
            question.addEventListener('click', () => {
                const item = question.parentElement;
                const isOpen = item.classList.contains('open');
                
                // Close all other items
                document.querySelectorAll('.faq-item').forEach(i => i.classList.remove('open'));
                
                // Toggle current item
                if (!isOpen) {
                    item.classList.add('open');
                }
            });
        });

        // =====================================================================
        // STRIPE SUBSCRIPTION HANDLERS
        // =====================================================================
        
        /**
         * Subscribe to a tier (Premium or Pro)
         * Handles authentication check and Stripe checkout session creation
         */
        async function subscribeToTier(tier) {
            console.log('subscribeToTier called with tier:', tier);
            
            const button = document.getElementById('btn-' + tier);
            if (button) {
                button.classList.add('loading');
                button.disabled = true;
            }
            
            try {
                // Wait for Clerk to load
                if (typeof Clerk === 'undefined') {
                    console.log('Clerk not defined, redirecting to app');
                    window.location.href = '/app?subscribe=' + tier;
                    return;
                }
                
                // Ensure Clerk is fully loaded
                await Clerk.load();
                
                const user = Clerk.user;
                
                if (!user) {
                    // User not signed in - redirect to app which will show sign-in modal
                    console.log('User not signed in, redirecting to app');
                    window.location.href = '/app?subscribe=' + tier;
                    return;
                }
                
                console.log('User signed in:', user.username || user.id);
                
                // Get auth token
                const token = await Clerk.session.getToken();
                
                if (!token) {
                    console.error('Failed to get auth token');
                    alert('Authentication error. Please try signing in again.');
                    return;
                }
                
                // Create checkout session
                const response = await fetch('/api/stripe/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ 
                        tier: tier,
                        email: user.primaryEmailAddress ? user.primaryEmailAddress.emailAddress : null
                    })
                });
                
                const data = await response.json();
                console.log('Checkout session response:', data);
                
                if (data.error) {
                    if (data.error === 'already_subscribed') {
                        if (confirm(data.message + '\n\nWould you like to manage your subscription?')) {
                            await manageSubscription();
                        }
                    } else {
                        alert('Error: ' + (data.message || data.error));
                    }
                    return;
                }
                
                if (data.url) {
                    // Redirect to Stripe Checkout
                    console.log('Redirecting to Stripe Checkout:', data.url);
                    window.location.href = data.url;
                } else {
                    alert('Failed to create checkout session. Please try again.');
                }
                
            } catch (error) {
                console.error('Subscription error:', error);
                alert('Failed to start checkout. Please try again.');
            } finally {
                if (button) {
                    button.classList.remove('loading');
                    button.disabled = false;
                }
            }
        }

        /**
         * Open Stripe Customer Portal for subscription management
         */
        async function manageSubscription() {
            console.log('manageSubscription called');
            
            try {
                if (typeof Clerk === 'undefined') {
                    window.location.href = '/app';
                    return;
                }
                
                await Clerk.load();
                
                if (!Clerk.user) {
                    window.location.href = '/app';
                    return;
                }
                
                const token = await Clerk.session.getToken();
                
                const response = await fetch('/api/stripe/customer-portal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    }
                });
                
                const data = await response.json();
                console.log('Customer portal response:', data);
                
                if (data.error) {
                    alert(data.message || 'Unable to open subscription portal.');
                    return;
                }
                
                if (data.url) {
                    window.location.href = data.url;
                }
                
            } catch (error) {
                console.error('Portal error:', error);
                alert('Failed to open subscription portal. Please try again.');
            }
        }
    </script>
</body>
</html>
