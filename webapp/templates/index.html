{% extends "layout.html" %}

{% block content %}
<div class="container-fluid p-4">
    <div class="row">
        
        <!-- LEFT PANEL: Configuration -->
        <div class="col-md-4 border-end" id="configPanel">
            <h4 class="mb-4 text-primary"><i class="fas fa-sliders-h me-2"></i>Portfolio Configuration</h4>
            
            <!-- Time Period -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-light py-2">
                    <h6 class="mb-0 small fw-bold">TIME PERIOD</h6>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label small">Start Date</label>
                            <input type="date" class="form-control form-control-sm" id="startDate" value="2018-01-01">
                        </div>
                        <div class="col-6">
                            <label class="form-label small">End Date</label>
                            <input type="date" class="form-control form-control-sm" id="endDate">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Optimization Settings -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-light py-2">
                    <h6 class="mb-0 small fw-bold">OPTIMIZATION</h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="form-label small">Optimization Goal</label>
                        <select class="form-select form-select-sm" id="optGoal" onchange="updateConditionalFields()">
                            <optgroup label="Mean-Variance">
                                <option value="max_sharpe">Maximize Sharpe Ratio</option>
                                <option value="min_volatility">Minimize Volatility</option>
                                <option value="min_vol_target_return">Minimize Volatility subject to Target Return</option>
                                <option value="max_return_target_vol">Maximize Return subject to Target Volatility</option>
                            </optgroup>
                            <optgroup label="Risk Metrics">
                                <option value="risk_parity">Risk Parity</option>
                                <option value="min_cvar">CVaR - Minimize Conditional Value-at-Risk</option>
                                <option value="min_cvar_target_return">CVaR - Min CVaR subject to Target Return</option>
                                <option value="max_return_target_cvar">CVaR - Max Return subject to Target CVaR</option>
                            </optgroup>
                            <optgroup label="Tracking Error">
                                <option value="min_tracking_error">Minimize Tracking Error</option>
                                <option value="max_information_ratio">Maximize Information Ratio</option>
                                <option value="max_excess_return_target_te">Max Excess Return subject to Target TE</option>
                            </optgroup>
                            <optgroup label="Advanced">
                                <option value="max_kelly">Maximize Kelly Criterion</option>
                                <option value="min_drawdown_target_return">Min Max Drawdown subject to Target Return</option>
                                <option value="max_omega_target_return">Max Omega Ratio subject to Target Return</option>
                                <option value="max_sortino_target_return">Max Sortino Ratio subject to Target Return</option>
                            </optgroup>
                            <optgroup label="Robust (Monte Carlo)">
                                <option value="robust_max_sharpe">Robust Max Sharpe Ratio</option>
                                <option value="robust_min_volatility">Robust Min Volatility</option>
                                <option value="robust_min_vol_target_return">Robust Min Vol @ Target Return</option>
                                <option value="robust_max_return_target_vol">Robust Max Return @ Target Vol</option>
                            </optgroup>
                            <optgroup label="Baseline">
                                <option value="equal_weight">Equal Weight</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="mb-2" id="targetReturnField" style="display:none;">
                        <label class="form-label small">Target Annual Return (%)</label>
                        <input type="number" class="form-control form-control-sm" id="targetReturn" value="15" step="0.5">
                    </div>
                    
                    <div class="mb-2" id="targetVolField" style="display:none;">
                        <label class="form-label small">Target Annual Volatility (%)</label>
                        <input type="number" class="form-control form-control-sm" id="targetVolatility" value="15" step="0.5">
                    </div>
                    
                    <div class="mb-2" id="targetCVaRField" style="display:none;">
                        <label class="form-label small">Target Monthly CVaR (%)</label>
                        <input type="number" class="form-control form-control-sm" id="targetCVaR" value="-2" step="0.1">
                    </div>
                    
                    <div class="mb-2" id="targetTEField" style="display:none;">
                        <label class="form-label small">Target Tracking Error (%)</label>
                        <input type="number" class="form-control form-control-sm" id="targetTE" value="5" step="0.5">
                    </div>
                    
                    <div class="mb-2">
                        <label class="form-label small">Benchmark</label>
                        <select class="form-select form-select-sm" id="benchmark">
                            <option value="SPY.US">S&P 500 (SPY)</option>
                            <option value="">None</option>
                        </select>
                    </div>
                    
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="useUserBenchmark" onchange="toggleUserBenchmark()">
                        <label class="form-check-label small" for="useUserBenchmark">Use Saved Portfolio as Benchmark</label>
                    </div>
                    
                    <div class="mb-2" id="userBenchmarkField" style="display:none;">
                        <label class="form-label small">Saved Portfolio Benchmark</label>
                        <select class="form-select form-select-sm" id="userBenchmark">
                            <option value="">Select a saved portfolio...</option>
                        </select>
                    </div>
                    
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="useConstraints" checked onchange="toggleConstraints()">
                        <label class="form-check-label small" for="useConstraints">Use Asset Constraints</label>
                    </div>
                    
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="showDiversification" checked>
                        <label class="form-check-label small" for="showDiversification">Show Diversification Analytics</label>
                    </div>
                    
                    <div class="mb-2" id="robustResamplesField" style="display:none;">
                        <label class="form-label small">Robust Resamples</label>
                        <select class="form-select form-select-sm" id="robustResamples">
                            <option value="50">50 (Fast)</option>
                            <option value="100" selected>100 (Balanced)</option>
                            <option value="200">200 (Thorough)</option>
                        </select>
                        <small class="text-muted">More resamples = more stable but slower</small>
                    </div>
                </div>
            </div>
            
            <!-- Health Score Settings (Collapsible) -->
            <div class="card mb-3 shadow-sm" id="healthScoreCard" style="display:none;">
                <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 small fw-bold">HEALTH SCORE WEIGHTS</h6>
                    <button class="btn btn-xs btn-outline-secondary py-0 px-2" type="button" data-bs-toggle="collapse" data-bs-target="#healthScoreBody">
                        <i class="fas fa-cog small"></i>
                    </button>
                </div>
                <div class="collapse" id="healthScoreBody">
                    <div class="card-body p-2">
                        <p class="small text-muted mb-2">Adjust how the Health Score is calculated (must sum to 100)</p>
                        <div class="row g-2 small">
                            <div class="col-6">
                                <label class="form-label small mb-1">Sharpe Ratio</label>
                                <input type="number" class="form-control form-control-sm health-weight" id="healthSharpe" value="40" min="0" max="100">
                            </div>
                            <div class="col-6">
                                <label class="form-label small mb-1">Diversification Ratio</label>
                                <input type="number" class="form-control form-control-sm health-weight" id="healthDivRatio" value="30" min="0" max="100">
                            </div>
                            <div class="col-6">
                                <label class="form-label small mb-1">HHI (Concentration)</label>
                                <input type="number" class="form-control form-control-sm health-weight" id="healthHHI" value="10" min="0" max="100">
                            </div>
                            <div class="col-6">
                                <label class="form-label small mb-1">Drawdown Duration</label>
                                <input type="number" class="form-control form-control-sm health-weight" id="healthDrawdown" value="20" min="0" max="100">
                            </div>
                        </div>
                        <div class="mt-2 text-end">
                            <span class="small text-muted">Total: </span>
                            <span class="small fw-bold" id="healthWeightTotal">100</span>
                            <span class="small text-muted">%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assets Table -->
            <div class="card shadow-sm">
                <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 small fw-bold">PORTFOLIO ASSETS</h6>
                    <button class="btn btn-xs btn-outline-primary py-0 px-2" onclick="addAssetRow()">
                        <i class="fas fa-plus small"></i> Add
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 40vh; overflow-y: auto;">
                        <table class="table table-sm table-hover align-middle mb-0 small" id="assetsTable">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 35%">Ticker</th>
                                    <th style="width: 20%">Alloc %</th>
                                    <th style="width: 18%" class="constraint-col">Min %</th>
                                    <th style="width: 18%" class="constraint-col">Max %</th>
                                    <th style="width: 9%"></th>
                                </tr>
                            </thead>
                            <tbody id="assetsTableBody"></tbody>
                            <tfoot class="table-light sticky-bottom">
                                <tr>
                                    <td class="text-end">Total:</td>
                                    <td id="totalAllocation" class="text-primary">0%</td>
                                    <td colspan="3"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="card-footer p-2 bg-white">
                    <button class="btn btn-primary w-100" id="runOptimizeBtn">
                        <i class="fas fa-bolt me-2"></i>Run Optimization
                    </button>
                </div>
            </div>

            <!-- Group Constraints (NEW) -->
            <div class="card mt-3 shadow-sm" id="groupConstraintsCard" style="display:none;">
                <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 small fw-bold">GROUP CONSTRAINTS</h6>
                    <div class="form-check form-switch mb-0">
                        <input class="form-check-input" type="checkbox" id="useGroupConstraints">
                        <label class="form-check-label small" for="useGroupConstraints">Enable</label>
                    </div>
                </div>
                <div class="card-body p-2">
                    <p class="small text-muted mb-2">
                        <i class="fas fa-info-circle me-1"></i>Set allocation limits by asset group
                    </p>
                    
                    <div class="table-responsive" style="max-height: 25vh; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0 small" id="groupConstraintsTable">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 30%">Group</th>
                                    <th style="width: 12%" class="text-center">Assets</th>
                                    <th style="width: 16%" class="text-center">Current</th>
                                    <th style="width: 21%">Min %</th>
                                    <th style="width: 21%">Max %</th>
                                </tr>
                            </thead>
                            <tbody id="groupConstraintsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Save Portfolio -->
            <div class="card mt-3 shadow-sm">
                <div class="card-body p-2">
                    <div class="input-group input-group-sm mb-2">
                        <input type="text" class="form-control" id="portfolioName" placeholder="Portfolio name">
                        <button class="btn btn-outline-secondary" onclick="savePortfolio()">
                            <i class="fas fa-save"></i> Save
                        </button>
                        <button class="btn btn-outline-secondary" onclick="loadPortfolioModal()">
                            <i class="fas fa-folder-open"></i> Load
                        </button>
                    </div>
                    <div class="form-check form-switch mb-2" id="publicPortfolioOption" style="display: none;">
                        <input class="form-check-input" type="checkbox" id="makePortfolioPublic">
                        <label class="form-check-label small" for="makePortfolioPublic">
                            <i class="fas fa-globe me-1"></i>Share in public rankings
                        </label>
                    </div>
                    <div class="btn-group btn-group-sm w-100 mb-2" role="group">
                        <button type="button" class="btn btn-outline-secondary" onclick="exportPortfolioCSV()" title="Export to CSV">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="importPortfolioCSV()" title="Import from CSV">
                            <i class="fas fa-upload"></i> Import
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="quickPasteTickers()" title="Quick paste tickers">
                            <i class="fas fa-paste"></i> Paste
                        </button>
                    </div>
                    
                    <label class="form-label small mb-1">Manage Saved Portfolios</label>
                    <div class="input-group input-group-sm">
                        <select class="form-select" id="portfolioManager" onchange="portfolioSelected()">
                            <option value="">Select to manage...</option>
                        </select>
                        <button class="btn btn-outline-danger" onclick="deleteSelectedPortfolio()" id="deletePortfolioBtn" disabled>
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: Results -->
        <div class="col-md-8" id="resultsPanel">
            
            <!-- Disclaimer Banner Above Results -->
            <div class="alert alert-warning py-2 mb-3" style="background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3);">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Not investment advice.</strong> Results are hypothetical and based on historical data. Past performance ≠ future results.
                <a href="/disclaimer" target="_blank" class="ms-1">Full disclaimer</a>
            </div>
            
            <div id="resultsPlaceholder" class="text-center py-5 text-muted">
                <i class="fas fa-chart-pie fa-4x mb-3 text-light"></i>
                <h5>Ready to Optimize</h5>
                <p>Configure your assets and click "Run Optimization"</p>
            </div>

            <div id="loadingSpinner" class="text-center py-5" style="display:none;">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                <p class="text-muted mt-3">Optimizing...</p>
            </div>

            <div id="resultsContent" style="display:none;">
                <h4 class="mb-3">Performance Comparison</h4>
                
                <!-- Comparison Table -->
                <div class="table-responsive mb-4">
                    <table class="table table-sm table-hover small" id="comparisonTable">
                        <thead class="table-light">
                            <tr>
                                <th>Metric</th>
                                <th id="colYour">Your Portfolio</th>
                                <th id="colOpt">Optimized</th>
                                <th id="colBench">Benchmark</th>
                            </tr>
                        </thead>
                        <tbody id="comparisonBody"></tbody>
                    </table>
                </div>

                <!-- Allocation Tables -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white py-2">
                                <h6 class="mb-0 small" id="optCardTitle">Optimized Portfolio</h6>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-sm table-hover mb-0 small">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Ticker</th>
                                            <th class="text-end">Weight</th>
                                        </tr>
                                    </thead>
                                    <tbody id="optTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header bg-secondary text-white py-2">
                                <h6 class="mb-0 small">Your Portfolio</h6>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-sm table-hover mb-0 small">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Ticker</th>
                                            <th class="text-end">Weight</th>
                                        </tr>
                                    </thead>
                                    <tbody id="yourTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white py-2">
                                <h6 class="mb-0 small" id="benchCardTitle">Benchmark</h6>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-sm table-hover mb-0 small">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Ticker</th>
                                            <th class="text-end">Weight</th>
                                        </tr>
                                    </thead>
                                    <tbody id="benchTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Group Allocations Display (NEW) -->
                <div class="card mb-4 shadow-sm" id="groupAllocationsSection" style="display:none;">
                    <div class="card-header bg-info text-white py-2">
                        <h6 class="mb-0 small"><i class="fas fa-layer-group me-2"></i>Group Allocations</h6>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-sm table-hover mb-0 small">
                            <thead class="table-light">
                                <tr>
                                    <th>Group</th>
                                    <th class="text-end">Your Portfolio</th>
                                    <th class="text-end">Optimized</th>
                                    <th class="text-center">Constraints</th>
                                </tr>
                            </thead>
                            <tbody id="groupAllocBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <ul class="nav nav-tabs card-header-tabs" id="resultTabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#frontier">Efficient Frontier</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#drawdown">Drawdown</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#monthly">Monthly Returns</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#correlation">Correlation</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#diversification">Diversification</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#savedPortfolios">Saved Portfolios</a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="frontier">
                                <div id="frontierChart" style="height: 500px;"></div>
                            </div>
                            <div class="tab-pane fade" id="drawdown">
                                <div id="drawdownChart" style="height: 400px;"></div>
                                <h6 class="mt-3 text-muted small">Historical Stress Periods</h6>
                                <table class="table table-sm" id="stressTable">
                                    <thead><tr><th>Event</th><th>Start</th><th>End</th><th class="text-end">Return</th></tr></thead>
                                    <tbody id="stressTableBody"></tbody>
                                </table>
                            </div>
                            <div class="tab-pane fade" id="monthly">
                                <div id="monthlyHeatmap"></div>
                            </div>
                            <div class="tab-pane fade" id="correlation">
                                <div id="corrHeatmap" style="height: 500px;"></div>
                            </div>
                            <div class="tab-pane fade" id="diversification">
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="text-muted small mb-3"><i class="fas fa-chart-radar me-2"></i>Portfolio Health Comparison</h6>
                                    </div>
                                </div>
                                
                                <!-- Health Score Cards -->
                                <div class="row g-3 mb-4" id="healthScoreCards">
                                    <div class="col-md-4">
                                        <div class="card h-100 border-primary">
                                            <div class="card-body text-center">
                                                <h6 class="card-subtitle mb-2 text-muted small">Optimized</h6>
                                                <h2 class="display-4 text-primary mb-0" id="optHealthScore">--</h2>
                                                <p class="text-muted small mb-0">Health Score</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card h-100 border-secondary">
                                            <div class="card-body text-center">
                                                <h6 class="card-subtitle mb-2 text-muted small">Your Portfolio</h6>
                                                <h2 class="display-4 text-secondary mb-0" id="userHealthScore">--</h2>
                                                <p class="text-muted small mb-0">Health Score</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card h-100 border-success">
                                            <div class="card-body text-center">
                                                <h6 class="card-subtitle mb-2 text-muted small">Benchmark</h6>
                                                <h2 class="display-4 text-success mb-0" id="benchHealthScore">--</h2>
                                                <p class="text-muted small mb-0">Health Score</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Diversification Metrics Table -->
                                <div class="table-responsive mb-4">
                                    <table class="table table-sm table-hover small" id="diversificationTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Metric</th>
                                                <th class="text-center">Your Portfolio</th>
                                                <th class="text-center">Optimized</th>
                                                <th class="text-center">Benchmark</th>
                                                <th>Interpretation</th>
                                            </tr>
                                        </thead>
                                        <tbody id="diversificationBody"></tbody>
                                    </table>
                                </div>
                                
                                <!-- Radar Chart -->
                                <div id="radarChart" style="height: 450px;"></div>
                            </div>
                            <div class="tab-pane fade" id="savedPortfolios">
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <h6 class="text-muted small">Compare Saved Portfolios</h6>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="input-group input-group-sm mb-1">
                                            <select class="form-select form-select-sm" id="portfolioCompareSelect" multiple style="height: 120px;">
                                                <option value="SPY.US">S&P 500 (SPY)</option>
                                            </select>
                                        </div>
                                        <button class="btn btn-sm btn-primary w-100" onclick="compareSelectedPortfolios()">
                                            <i class="fas fa-chart-bar me-1"></i>Compare Selected
                                        </button>
                                        <small class="text-muted d-block mt-1">Hold Ctrl to select multiple</small>
                                    </div>
                                </div>
                                <div id="portfolioComparisonTable"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer with Legal Links -->
<footer class="bg-dark text-light py-3 mt-4 border-top">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-6">
                <small class="text-muted">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    FolioForecast is for educational purposes only. Not investment advice.
                </small>
            </div>
            <div class="col-md-6 text-md-end">
                <a href="/terms" class="text-muted small me-3">Terms</a>
                <a href="/privacy" class="text-muted small me-3">Privacy</a>
                <a href="/disclaimer" class="text-muted small me-3">Disclaimer</a>
                <a href="/pricing" class="text-muted small">Pricing</a>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-12 text-center">
                <small class="text-muted">© 2026 FolioForecast. All rights reserved.</small>
            </div>
        </div>
    </div>
</footer>

<!-- Load Portfolio Modal -->
<div class="modal fade" id="loadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Load Portfolio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="portfolioList" class="list-group"></div>
            </div>
        </div>
    </div>
</div>

<!-- ================================================== -->
<!-- STEP 1: Terms of Service Modal -->
<!-- ================================================== -->
<div class="modal fade" id="termsModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-warning">
                    <i class="fas fa-file-contract me-2"></i>
                    Terms of Service
                </h5>
                <span class="badge bg-secondary ms-auto">Step 1 of 2</span>
            </div>
            <div class="modal-body py-4" style="max-height: 60vh; overflow-y: auto;">
                <div class="mb-4 text-center">
                    <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
                    <h4>Welcome to FolioForecast</h4>
                    <p class="text-light">Please read and accept our Terms of Service to continue.</p>
                </div>
                
                <div class="px-3">
                    <h6 class="text-warning mb-3"><i class="fas fa-gavel me-2"></i>Key Terms</h6>
                    
                    <div class="mb-4">
                        <h6 class="text-light"><i class="fas fa-check-circle text-success me-2"></i>Service Description</h6>
                        <p class="text-light ps-4 mb-2">FolioForecast provides mathematical portfolio analysis and optimization tools for educational purposes. We do not provide investment advice, recommendations, or personalized financial guidance.</p>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="text-light"><i class="fas fa-check-circle text-success me-2"></i>User Responsibilities</h6>
                        <p class="text-light ps-4 mb-2">You are solely responsible for your investment decisions. You must be at least 18 years old to use this service. You agree to provide accurate information and maintain the security of your account.</p>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="text-light"><i class="fas fa-ban text-danger me-2"></i>No Refund Policy</h6>
                        <p class="text-light ps-4 mb-2"><strong class="text-warning">All subscription payments are final and non-refundable.</strong> By subscribing, you acknowledge that you will not receive a refund for any unused portion of your subscription period. Please use the free tier to evaluate the service before subscribing.</p>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="text-light"><i class="fas fa-check-circle text-success me-2"></i>Intellectual Property</h6>
                        <p class="text-light ps-4 mb-2">All content, features, and functionality are owned by FolioForecast and are protected by copyright and trademark laws.</p>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="text-light"><i class="fas fa-check-circle text-success me-2"></i>Limitation of Liability</h6>
                        <p class="text-light ps-4 mb-2">FolioForecast shall not be liable for any direct, indirect, incidental, special, or consequential damages resulting from the use or inability to use this service, including any losses from investment decisions.</p>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="text-light"><i class="fas fa-check-circle text-success me-2"></i>Changes to Terms</h6>
                        <p class="text-light ps-4 mb-2">We reserve the right to modify these terms at any time. Continued use of the service constitutes acceptance of modified terms.</p>
                    </div>
                    
                    <p class="small text-info mt-4">
                        <i class="fas fa-info-circle me-1"></i>
                        <a href="/terms" target="_blank" class="text-info">View full Terms of Service</a>
                    </p>
                </div>
            </div>
            <div class="modal-footer border-secondary justify-content-center">
                <button type="button" class="btn btn-warning btn-lg px-5" id="acceptTermsBtn">
                    <i class="fas fa-check me-2"></i>I Understand & Accept Terms
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ================================================== -->
<!-- STEP 2: Investment Disclaimer Modal -->
<!-- ================================================== -->
<div class="modal fade" id="disclaimerModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Investment Disclaimer
                </h5>
                <span class="badge bg-secondary ms-auto">Step 2 of 2</span>
            </div>
            <div class="modal-body py-4" style="max-height: 60vh; overflow-y: auto;">
                <div class="mb-4 text-center">
                    <i class="fas fa-chart-pie fa-3x text-danger mb-3"></i>
                    <h4 class="text-light">Important Investment Warnings</h4>
                    <p class="text-light">Please carefully read these critical disclaimers before using FolioForecast.</p>
                </div>
                
                <div class="px-3">
                    <div class="alert alert-danger mb-4">
                        <h6 class="alert-heading"><i class="fas fa-ban me-2"></i>This Is NOT Investment Advice</h6>
                        <p class="mb-0">FolioForecast is a mathematical tool only. We do not provide investment recommendations, financial advice, or personalized guidance of any kind.</p>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-times-circle text-danger me-3 mt-1 fa-lg"></i>
                                <div>
                                    <h6 class="text-light mb-1">No Guarantees</h6>
                                    <p class="text-light small mb-0">Past performance does not predict future results. All backtests are hypothetical and may not reflect actual trading results.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-times-circle text-danger me-3 mt-1 fa-lg"></i>
                                <div>
                                    <h6 class="text-light mb-1">Risk of Loss</h6>
                                    <p class="text-light small mb-0">All investments carry risk. You could lose some or all of your invested capital. Never invest more than you can afford to lose.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-times-circle text-danger me-3 mt-1 fa-lg"></i>
                                <div>
                                    <h6 class="text-light mb-1">Do Your Own Research</h6>
                                    <p class="text-light small mb-0">Consult a qualified financial advisor before making any investment decisions. This tool is for educational purposes only.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-times-circle text-danger me-3 mt-1 fa-lg"></i>
                                <div>
                                    <h6 class="text-light mb-1">Your Responsibility</h6>
                                    <p class="text-light small mb-0">You are solely responsible for your investment choices. FolioForecast accepts no liability for any financial losses.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-times-circle text-danger me-3 mt-1 fa-lg"></i>
                                <div>
                                    <h6 class="text-light mb-1">Data Limitations</h6>
                                    <p class="text-light small mb-0">Historical data may contain errors or omissions. Results depend on data quality and may differ from reality.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-times-circle text-danger me-3 mt-1 fa-lg"></i>
                                <div>
                                    <h6 class="text-light mb-1">Model Limitations</h6>
                                    <p class="text-light small mb-0">All optimization models have limitations and assumptions that may not hold in real market conditions.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <p class="small text-info mt-4">
                        <i class="fas fa-info-circle me-1"></i>
                        <a href="/disclaimer" target="_blank" class="text-info">View full Investment Disclaimer</a>
                    </p>
                </div>
            </div>
            <div class="modal-footer border-secondary justify-content-center">
                <button type="button" class="btn btn-warning btn-lg px-5" id="acceptDisclaimerBtn">
                    <i class="fas fa-check me-2"></i>I Understand & Accept Disclaimer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/main.js"></script>
<script>
// ============================================
// AGREEMENT MODALS - TWO-STEP FLOW
// Version: 1.0.0 (2026-01-25)
// ============================================

const AGREEMENT_VERSIONS = {
    terms: '1.0.0',
    disclaimer: '1.0.0'
};

// Check if user has agreed to both Terms and Disclaimer
async function checkAgreementStatus() {
    // First check localStorage (for non-logged-in users)
    const localTerms = localStorage.getItem('folioforecast_terms_agreed');
    const localDisclaimer = localStorage.getItem('folioforecast_disclaimer_agreed');
    
    // If user is logged in, check server-side
    if (window.Clerk && window.Clerk.user) {
        try {
            const response = await fetch('/api/agreement-status', {
                headers: {
                    'Authorization': `Bearer ${await window.Clerk.session.getToken()}`
                }
            });
            if (response.ok) {
                const data = await response.json();
                if (data.terms_agreed_at && data.disclaimer_agreed_at) {
                    // User has agreed on server, update localStorage and skip modals
                    localStorage.setItem('folioforecast_terms_agreed', data.terms_agreed_at);
                    localStorage.setItem('folioforecast_disclaimer_agreed', data.disclaimer_agreed_at);
                    return true;
                }
            }
        } catch (e) {
            console.log('Could not check server agreement status:', e);
        }
    }
    
    // Check local storage
    return localTerms && localDisclaimer;
}

// Save agreement to server (for logged-in users)
async function saveAgreementToServer(agreementType, version) {
    if (window.Clerk && window.Clerk.user) {
        try {
            const response = await fetch('/api/record-agreement', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${await window.Clerk.session.getToken()}`
                },
                body: JSON.stringify({
                    agreement_type: agreementType,
                    version: version,
                    agreed_at: new Date().toISOString()
                })
            });
            return response.ok;
        } catch (e) {
            console.log('Could not save agreement to server:', e);
            return false;
        }
    }
    return true; // Return true for non-logged-in users (just use localStorage)
}

// Initialize agreement flow
async function initAgreementFlow() {
    const hasAgreed = await checkAgreementStatus();
    
    if (!hasAgreed) {
        // Show Terms modal first (Step 1)
        setTimeout(() => {
            const termsModal = new bootstrap.Modal(document.getElementById('termsModal'));
            termsModal.show();
        }, 500);
    }
}

// Handle Terms acceptance (Step 1)
document.getElementById('acceptTermsBtn').addEventListener('click', async function() {
    const now = new Date().toISOString();
    
    // Save to localStorage
    localStorage.setItem('folioforecast_terms_agreed', now);
    localStorage.setItem('folioforecast_terms_version', AGREEMENT_VERSIONS.terms);
    
    // Save to server
    await saveAgreementToServer('terms', AGREEMENT_VERSIONS.terms);
    
    // Hide Terms modal
    const termsModal = bootstrap.Modal.getInstance(document.getElementById('termsModal'));
    termsModal.hide();
    
    // Show Disclaimer modal (Step 2)
    setTimeout(() => {
        const disclaimerModal = new bootstrap.Modal(document.getElementById('disclaimerModal'));
        disclaimerModal.show();
    }, 300);
});

// Handle Disclaimer acceptance (Step 2)
document.getElementById('acceptDisclaimerBtn').addEventListener('click', async function() {
    const now = new Date().toISOString();
    
    // Save to localStorage
    localStorage.setItem('folioforecast_disclaimer_agreed', now);
    localStorage.setItem('folioforecast_disclaimer_version', AGREEMENT_VERSIONS.disclaimer);
    
    // Save to server
    await saveAgreementToServer('disclaimer', AGREEMENT_VERSIONS.disclaimer);
    
    // Hide Disclaimer modal
    const disclaimerModal = bootstrap.Modal.getInstance(document.getElementById('disclaimerModal'));
    disclaimerModal.hide();
    
    // User is now good to go!
    console.log('User has accepted all agreements');
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Wait for Clerk to initialize (if present)
    if (window.Clerk) {
        window.Clerk.load().then(() => {
            initAgreementFlow();
        });
    } else {
        // No Clerk, just check localStorage
        initAgreementFlow();
    }
});
</script>
{% endblock %}
